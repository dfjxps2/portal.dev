<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.quick.portal.secMetricConfig.ISecMetricConfigDao">
	
    <!--查询条件-->
	<sql id="where">
		1=1
		<if test="start_time != null and start_time != '' and start_time != 'null'"><![CDATA[
	       and a.cre_time >= #{start_time}
	    ]]></if>
		<if test="end_time != null and end_time != '' and end_time != 'null'"><![CDATA[
	       and a.cre_time <= #{end_time}
	    ]]></if>
		<if test="config_ver != null and config_ver != '' and config_ver != 'null'"><![CDATA[
	       and c.version_num !='' Or c.version_num!= null
	    ]]></if>
		<if test="user_id != null and user_id != '' and user_id != 'null'"><![CDATA[
	       and a.user_id = #{user_id}
	    ]]></if>

        <if test="_sql_where != null and _sql_where != ''"> <![CDATA[
            and ${_sql_where}
        ]]> </if>
	</sql>
	<!-- 删除 -->
	<delete id="delete" parameterType="String">
		delete from sec_metric_config where config_id = #{config_id}
	</delete>
	
	<!-- 删除 -->
	<delete id="deleteBySectionId" parameterType="String">
		delete from sec_metric_config where sec_metric_id = #{sec_metric_id}
	</delete>
    
    <!--查询-->
	<!--<select id="select" parameterType="map" resultType="map">
		select a.config_id config_id,a.user_id user_id,c.version_num version_num,
		concat('  指标栏目：',a.sec_metric_id,'  参数：',a.param_id,'  参数值：',a.param_value ) as details,
		/*a.sec_metric_id sec_metric_id,a.param_value param_value,*/
		 c.is_active as is_active ,
		a.cre_time cre_time
		from sec_metric_config a
		left join sys_user b on a.user_id=b.user_id
		left join user_config_version c on a.config_id=c.config_id

		<where>
			<include refid="where" />
		</where>
		order by a.cre_time DESC
	</select>-->
	<select id="select" parameterType="map" resultType="map">
		select a.config_id config_id,a.user_id user_id,c.version_num version_num,
		GROUP_CONCAT(a.param_value  ORDER BY a.config_id)  as details,
		 c.is_active as is_active ,
		a.cre_time cre_time
		from sec_metric_config a
		left join sys_user b on a.user_id=b.user_id
		left join user_config_version c on a.cre_time=c.cre_time
		<where>
			<include refid="where" />
		</where>
    GROUP BY a.cre_time order by a.cre_time DESC
	</select>
	
	<!-- 查询总记录数 -->
	<select id="count" parameterType="map" resultType="int">
		select count(*) from sec_metric_config a
		<where>
			<include refid="where" />
		</where>
	</select>
<!--查询用户激活配置表-->
	<select id="selectUAC" parameterType="map" resultType="int">
		select count(*) from user_config_version a
	    where a.user_id = #{user_id} and a.term_type_id=#{term_type_id} and a.cre_time=#{cre_time}
	</select>
	
	<!--查询用户当前版本时间-->
	<select id="selectTime" parameterType="int" resultType="map">
		select cre_time from user_config_version 
	    where user_id = #{user_id} and is_active = 1
	</select>
	
	 <!-- 新增metric -->
	<insert id="insert" parameterType="com.quick.portal.sectionMetric.SectionMetricDO">
		insert into sec_metric_config (
    		  user_id,
    		  sec_metric_id,
    		  param_id,
    		  param_value,
    		  cre_time
		)values(
			 #{user_id},
			 #{sec_metric_id},
			 #{param_id},
			 #{param_value},
			 #{cre_time}
			)
	</insert>
	
	<!--新增用户激活配置表-->
	<insert id="insertUAC" parameterType="map" >
		insert into user_config_version (

		user_id,
		term_type_id,
		cre_time,
		version_num,
		is_active
		)values(

		#{user_id},
		#{term_type_id},
		#{cre_time},
		#{version_num},
        #{is_active}
		)
	</insert>
	<insert id="insertUAC_Version" parameterType="map" >
		insert into user_config_version (
		user_id,
		is_active,
		term_type_id,
		cre_time,
		version_num
		)values(
		#{user_id},
		#{is_active},
		#{term_type_id},
		#{cre_time},
		#{version_num}
		)
	</insert>
	<!--修改用户激活配置表-->
	<update id="updateUAC_Active" parameterType="map" >
		update user_config_version
		set

	      is_active=#{is_active}

		/*0 未激活  1 激活*/
		where
		user_id = #{user_id} and term_type_id=#{term_type_id} and cre_time=#{cre_time}
	</update>
	
	<!--将用户当前版本关闭-->
	<update id="updateUserActive" parameterType="map" >
		update user_config_version
		set

	      is_active=0

		/*0 未激活  1 激活*/
		where
		is_active=1
		and user_id = #{user_id} and term_type_id=#{term_type_id}
	</update>
	<update id="updateUAC_Version" parameterType="map" >
		update user_config_version
		set
		version_num=#{version_num}
		where
		user_id = #{user_id} and term_type_id=#{term_type_id} and cre_time=#{cre_time}
	</update>
</mapper>
