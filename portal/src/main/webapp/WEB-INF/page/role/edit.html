<!DOCTYPE html>
<html>
<head>
    <#include "/WEB-INF/include/reslist.html" />
</head>

<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="col-sm-12">
                <div class="col-sm-10">
                    <label id="pagename" class="col-xs-8"
                           style="text-align:center;font-size: 22px;color:blue;margin-left: 180px">角色编辑</label>
                </div>
                <div class="col-sm-2">
                    <div class="pull-right ibox-toolbars hidefield" style="margin-bottom: 5px;">
                        <button type="button" class="btn btn-primary" onclick="cancel();">返回</button>
                    </div>
                </div>
            </div>
            <div class="ibox">
                <div class="ibox-content ibox-content-ad">
                    <form style="padding-top: 30px;" id="form" action="${G.serverUrl}/save" class="wizard-big">
                        <input type="hidden" id="role_id" name="role_id" value=""/>
                        <div class="row">
                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require">*</span>角色名称</label>
                                    <div class="col-xs-9">
                                        <input maxlength="10" placeholder="输入2-10中文汉字或英文字母或数字的组合" id="role_name"
                                               name="role_name" type="text" class="form-control required">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require">*</span>角色类型</label>
                                    <div class="col-xs-9">
                                        <select name="role_type_id" class="form-control required select_change"
                                                id="role_type_id">
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require">*</span>角色状态</label>
                                    <div class="col-xs-9">
                                        <select name="role_state" class="form-control required" id="role_state">
                                            <option value="1">启用</option>
                                            <option value="0">停用</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-12 form_ipt_botm">
                                <div class="form-group pull-right">
                                    <div class="col-xs-2" style="width:150px;">
                                        <input class="btn btn-primary" style="width:120px;" type="button"
                                               onclick="addRoleUser();" value="添加角色成员">
                                    </div>
                                    <div class="col-xs-2" style="width:150px;">
                                        <input class="btn btn-primary " style="width:120px;" type="button"
                                               onclick="deletRoleUser();" value="删除角色成员">
                                    </div>
                                    <div class="col-xs-3" style="width:160px;">
                                        <input id="submit-form" style="width:120px;" type="button"
                                               class="btn btn-primary" value="保存"
                                               onclick="return thingOver();">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="col-sm-12">
                        <label id="list-title" class="col-xs-11"
                               style="text-align:center;font-size: 18px;color:blue;">成员列表</label>
                    </div>
                    <div style="margin:5px;">
                        <table id="list" class="table-striped" style="table-layout:fixed"></table>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>
<script>
    var pageNum = 1;
    var pageSize = 10;
    var queryParm = '';
    var iscommit = false;
    //从URL,JSON中取值赋给表单元素

    var role_id = $.request.queryString["role_id"];

    var filter = "";
    if (role_id){
        filter = "(r.role_id = " + role_id;
        if (window.localStorage['selected_users']) {
            filter += ' or u.user_id in (' + window.localStorage['selected_users'] + ')';
        }
        filter += ")";
    }

    function config() {
        var RFlag = $.request.queryString["RFlag"];
        quick.serverUrl = "${G.serverUrl}";  // /sysUser
        quick.editUrl = "${G.editUrl}";       // sysUser/edit
        quick.objName = "${G.objName}";
        quick.idField = "${G.idField}";
        quick.listUrl = quick.serverUrl + "/list";

        $("#list").bootstrapTable("destroy");
        _gridPool["list"] = new BGrid("#list");
        _gridPool["list"].config({
            url: "${G.host}/sysUser/getList?filter=" + filter + "&i=" + Math.random(),
            idField: quick.idField,
            sortName: quick.idField,
            cache: false,
            height: $(document.body).height() - 100,
            toolbar: "#formSearch",
            columns: [
                {
                    field: 'TAGSELECT', title: '选择', width: '5%', align: 'center',
                    formatter: function (value, rec) {
                        return "<input id=\"msgs" + rec.user_id + "\" title=\"msgs\" class=\"ck_qx\" type=\"checkbox\" name=\"msg\" value=\"" + rec.user_id + "\" >";
                    }
                },
                {field: 'user_id', title: '用户ID', width: 70, align: 'center'},
                {field: 'user_name', title: '用户名称', width: 90, align: 'center'},
                {field: 'user_real_name', title: '用户真实名称', width: 90, align: 'center'},
                {field: 'dep_name', title: '用户部门名称', width: 110, align: 'center'}
            ], onPageChange: function (number, size) {
                pageNum = number;
                pageSize = size;
            }, onPostBody: function (data) {
                if (queryParm == '' && (data == null || data.length == 0)) {
                    $(".no-records-found td").html('您还没有添加相关信息，请点击新增角色用户按钮进行添加</a>');
                }
            }
        });

        if (RFlag == 1) {
            requery();
        } else {
            _gd["list"].init();
        }
    }

    //选中多选下拉框的值
    function ListInit(obj, v) {
        if (!obj) return false;
        var opts = $('#role_type_id option');
        for (var i in opts) {
            if (opts[i].value == v) {
                opts[i].selected = true;
            }
        }
    }

    var sysid = $.request.queryString["role_id"];
    window.onload = function () {
        if (window.localStorage['selected_users'])
            alert(window.localStorage['selected_users']);

        selectRoleType();
        if (sysid) {

            $.post(quick.serverUrl + '/getObj?role_id=' + sysid + "&i=" + Math.random(), function (data) {
                // console.log(JSON.stringify(data));
                if (data != null) {
                    $("#role_name").val(data.role_name);
                    $("#role_state").val(data.role_state);
                    $("#role_id").val(data.role_id);
                    ListInit("role_type_id", data.role_type_id);

                }
            });
        }

        jQuery.validator.addMethod("nameFuc", function (value, element) {//名称验证  只能是2-10中文汉字或英文字母或数字的组合
            var tel = /^[\u4E00-\u9FA5a-zA-Z0-9]{0,100}$/;
            return this.optional(element) || (tel.test(value));
        }, "格式不符合");

        jQuery.validator.addMethod("nameFuc1", function (value, element) {//名称验证
            var flag = true;
            if (value.length < 2 || value.length > 10) {
                flag = false;
            }
            return this.optional(element) || flag;
        }, "请输入2-10位字符");


        $("#form").validate({

            errorPlacement: function (error, element) {
                element.parent().append(error);
            },
            rules: {
                confirm: {
                    equalTo: "#role_id"
                },
                role_name: {
                    required: true,
                    nameFuc: true,
                    nameFuc1: true,
                    remote: {
                        url: "${G.serverUrl}/VerifiedExists",     //后台处理程序
                        type: "post",               //数据发送方式
                        dataType: "json",           //接受数据格式
                        data: {                     //要传递的数据
                            fieldName: 'role_name',
                            fieldValue: function () {
                                return $("#role_name").val();
                            },
                            id: function () {
                                return $("#role_id").val();
                            }
                        },
                        dataFilter: function (data, type) {//判断控制器返回的内容
                            return !(data === "true");
                        }
                    }
                },
                role_type_id: {
                    required: true
                }
            },
            messages: {
                role_name: {
                    remote: "已存在该角色名"
                },
                role_type_id: {
                    required: "请选择角色类型"
                }
            }
        });
    };

    function selectRoleType() {
        $.ajax({
            type: "get",
            url: "getRoleType",
            async: false,
            dataType: "json",
            success: function (data) {
                $("#role_type_id").append("<option selected hidden value=''>请选择角色类型</option><option value= ''>角色类型</option>");
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    $("#role_type_id").append("<option  value=" + item.roleTypeId + ">  " + item.roleTypeName + "</option>");
                }
            }
        });
    }

    function addRoleUser (){
        navAppend("新增角色用户");/*获取父页面元素并动态赋值父页面title*/
        window.location.href= "addRoleUser?role_id="+role_id;//跳转到另一个页面，并且还在当前框架
    }

    function roleUser() {
        window.location.href = "roleUsers?role_id=" + $("#role_id").val();//跳转到另一个页面，并且还在当前框架
    }

    /*完成*/
    function thingOver() {
        iscommit = true;

        if (!$("#form").valid())
            return false;

        quick.submit(function (data) {
            if (data.code !== 1) {
                layer.msg('保存失败,' + data.msg, {icon: 1, time: 3000, skin: 'layer-ext-moon'});
                isdone = true;
                return;
            }
            layer.msg('保存成功', {icon: 1, time: 1500, skin: 'layer-ext-moon'}, function () {
                cancel();
            });
        });
    }

    function cancel() {
        window.location.href = quick.listUrl + urlDel(location.search, 'mode', 'user_id') + '&RFlag=1';
    }
</script>
</body>

</html>
