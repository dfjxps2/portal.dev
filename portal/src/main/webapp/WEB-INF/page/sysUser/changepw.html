<!DOCTYPE html>
<html>
<head>
    <#include "/WEB-INF/include/reslist.html" />
</head>

<body class="gray-bg">
<div class="wrapper wrapper-content wrapper-content-x animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox ibox-x">
                <div class="ibox-content ibox-content-x">
                    <div class="panel-mar">
                        <form id="form"  class="wizard-big addForm"  enctype="multipart/form-data" accept="image/jpg, image/png">
                            <div class="col-xs-9"><input type="hidden" id="user_id" name="user_id" class="form-control" /></div>

                            <div class="col-sm-6 form_ipt_botm" style="width:100%;position: relative;">
                                <div class="form-group" style="width:100%;">
                                    <label class="col-xs-3 lable_top" style="width:30%;"><span class="span_require">*</span>原密码</label>
                                    <div class="col-xs-9" style="width:66%;"><input placeholder="请输入您以前的密码！" type="text" id="user_old_pw" name="old_password" class="form-control" style="width:600px;"/></div>
                                </div>
                            </div>
                            <div class="col-sm-6 form_ipt_botm" style="width:100%;position: relative;">
                                <div class="form-group" style="width:100%;">
                                    <label class="col-xs-3 lable_top" style="width:30%;"><span class="span_require">*</span>新密码</label>
                                    <div class="col-xs-9" style="width:66%;"><input placeholder="请输入您的新密码！" type="text" id="user_new_pw" name="new_password" class="form-control required" style="width:600px;"/></div>
                                </div>
                            </div>

                            <div class="col-sm-6 form_ipt_botm" style="width:100%;position: relative;">
                                <div class="form-group" style="width:100%;">
                                    <label class="col-xs-3 lable_top" style="width:30%;"><span class="span_require">*</span>新密码</label>
                                    <div class="col-xs-9" style="width:66%;"><input placeholder="请再次输入您的新密码！" type="text" id="user_renew_pw" name="re_new_pw" class="form-control" style="width:600px;"/></div>
                                </div>
                            </div>

                            <div class="row">
                                <div ibox-toolbars hidefield style="float:left;width:100%;height:80px;">
                                    <span class="input-group-btn" style="width:52%;" > <input id="submit-form" type="button" class="pull-right btn btn-primary" value="保存"/></span>
                                    <span class="input-group-btn" style="width:12%;"  > <button type="button" class="pull-right btn btn-primary" onclick="cancel();">返回</button></span>
                                </div>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script>

    var sysid=$.request.queryString["user_id"];
       quick.serverUrl = "${G.serverUrl}";  // /sysUser
    window.onload = function() {
        /*自定义错误提示信息的方法*/
        jQuery.validator.addMethod("newPassword", function (value, element) {
            var flag = true;
            if (value != $("#user_new_pw").val()) {
                flag = false
            }
            return this.optional(element) || flag;
        }, "您输入的新密码前后不一致！");
        jQuery.validator.addMethod("passwordFuc", function (value, element) {//密码验证
            var tel = /^[0-9a-zA-Z]{5,12}$/;
            return this.optional(element) || (tel.test(value));
        }, "6-12位英文字母或者数字的组合");
        $("#form").validate({
            errorPlacement: function (error, element) {
                element.parent().append(error);
            },
            rules: {
                re_new_pw: {
                    required: true,
                    newPassword: true,
                    passwordFuc: true
                },
                old_password: {
                    required: true,
                    passwordFuc: true,
                    remote: {
                        url: quick.serverUrl + "/checkOldPw",     //后台处理程序
                        type: "post",               //数据发送方式
                        dataType: "json",           //接受数据格式
                        data: {                     //要传递的数据
                            user_old_pw: function () {
                                return encodeURI($("#user_old_pw").val());
                            }
                        },
                        dataFilter: function (data, type) {//判断控制器返回的内容
                            //console.log(data);
                            if (data == "false") {
                                return false;
                            } else {
                                return true;
                            }
                        }
                    }
                },
                new_password:{
                    required: true,
                    passwordFuc: true
                }
            },
            messages:{
                old_password:{
                    remote:"您输入的密码不存在！"
                },
                re_new_pw:{
                    remote: " ni"
                },
                new_password:{
                    remote: " de"
                }
            }

        });
    }


        /*保存*/
        $("#submit-form").click(function () {
            if(!($("#form").valid())){
                return false;
            }

            var subData={
                user_id :sysid,
                new_password:encodeURI($("#user_new_pw").val())
            }
            $.ajax({
                type: "post",
                url:"changPw",
                data:subData,
                dataType: "json",
                success: function(data){
                    if(data=="1"){
                        layer.msg('密码修改已完成！', {icon:1,time: 1000,skin: 'layer-ext-moon'});
                    }else{
                        layer.msg('密码修改失败，请您检查自己的代码！', {icon:1,time: 1000,skin: 'layer-ext-moon'});
                    }
                },
                error:function () {
                    layer.msg('未知错误造成密码修改失败！', {icon:1,time: 1000,skin: 'layer-ext-moon'});
                }
            });
        })


    function cancel(){
        var url = quick.serverUrl+"/list";
        window.location.href = url;
    }
</script>
</html>