<!DOCTYPE html>
<html>
<head>
    <#include "/WEB-INF/include/resedit.html" />
    <script type="text/javascript" src="${G.host}/res/js/bootstrap-select.min.js"></script>
    <link rel="stylesheet" href="${G.host}/res/css/bootstrap-select.min.css" type="text/css"/>
    <!--<script type="text/javascript" src="${G.host}/res/plugin/jQuery/jquery-1.11.3.min.js"></script>-->

    <style>
        select::-ms-expand {
            display: none;
        }

        .btn-default {
            background-color: #FFF;
            border-color: #e5e6e7;
            color: #999;
        }

        .btn-default.active, .btn-default:active, .btn-default:focus, .btn-default:hover, .open .dropdown-toggle.btn-default {
            background-color: #FFF;
            border-color: #e5e6e7;
            color: #999;
        }

    </style>
</head>

<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="col-sm-10">
                <div class="col-sm-12">
                    <label id="pagename" class="col-xs-8"
                           style="text-align:center;font-size: 22px;color:blue;margin-left: 180px"></label>
                </div>
            </div>

            <div class="ibox">
                <div class="ibox-content ibox-content-ad" style="margin-top:55px;">
                    <form id="form" name="form" method="post" action="${G.serverUrl}/saveUser" class="wizard-big addForm"
                          enctype="multipart/form-data" accept="image/jpg, image/png">
                        <div class="row">
                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require">*</span>用户名称</label>
                                    <div class="col-xs-9"><input maxlength="20" type="text" id="user_name"
                                                                 name="user_name" class="form-control required"/></div>
                                </div>
                            </div>

                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require">*</span>角色名称</label>
                                    <div class="col-xs-9"><select
                                            class="form-control required select_change selectpicker" id="role_id"
                                            data-live-search="false" multiple name="role_ids"></select></div>
                                </div>
                            </div>

                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span></span>用户电话</label>
                                    <div class="col-xs-9"><input maxlength="11" placeholder="11位的数字" type="text"
                                                                 id="user_tel" name="user_tel" class="form-control"/>
                                    </div>
                                </div>
                            </div>


                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require">*</span>部门名称</label>
                                    <div class="col-xs-9"><select
                                            class="form-control required form-control-green select_change" id="dep_id"
                                            name="dep_id"></select></div>
                                </div>
                            </div>

                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require">*</span>岗位名称</label>
                                    <div class="col-xs-9"><select
                                            class="form-control required form-control-green select_change" id="job_id"
                                            name="job_id"></select></div>
                                </div>
                            </div>

                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require">*</span>真实名称</label>
                                    <div class="col-xs-9"><input type="text" id="user_real_name" name="user_real_name"
                                                                 class="form-control required"/></div>
                                </div>
                            </div>


                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require"></span>身份证号码</label>
                                    <div class="col-xs-9"><input type="text"  id="idcard_num"
                                            name="idcard_num" readonly  class="form-control"/></div>
                                </div>
                            </div>

                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require"></span>电子邮箱</label>
                                    <div class="col-xs-9"><input type="text" id="user_email" name="user_email"   class="form-control"/></div>
                                </div>
                            </div>


                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span></span>用户地址</label>
                                    <div class="col-xs-9"><textarea style="resize:none;" class="form-control"
                                                                    id="user_addr" name="user_addr"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top "><span class="span_require">*</span>激活状态</label>
                                    <div class="col-xs-9 radio_ipt">
                                        <label class="radio-inline">
                                            <input type="radio" name="user_state" id="user_state1" value="1"/>
                                            <label for="user_state1"></label>
                                            <span>是</span></label>
                                        <label class="radio-inline">
                                            <input type="radio" name="user_state" id="user_state0" value="0"/>
                                            <label for="user_state0"></label>
                                            <span>否</span></label></div>
                                </div>
                            </div>
                            <div ibox-toolbars hidefield style="float:left;width:62%;height:80px;margin-top:30px;">
                                <li class="li_bom" style="height:70px;">
                                    <span class="input-group-btn" style="width:9%;"> <input id="submit-form"
                                                                                            type="button"
                                                                                            class="pull-right  btn btn-primary"
                                                                                            value="保存"/> </span>
                                    <span class="input-group-btn"><input id="reset" class="pull-right btn btn-primary"
                                                                         type="button" value="返回" onclick="cancel();"/></span>
                                </li>
                            </div>
                            <div class="col-xs-9"><input type="hidden" id="user_id" name="user_id"
                                                         class="form-control"/></div>
                            <div class="col-xs-9"><input type="hidden" id="rela_id" name="rela_id"
                                                         class="form-control"/></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

</body>
<script>

    quick.baseUrl = "${G.host}";

    function config() {
        quick.serverUrl = "${G.serverUrl}";
        quick.objName = "${G.objName}";
        quick.idField = "${G.idField}";
        quick.listUrl = quick.serverUrl + "/list";
    }

    var selector = $('.selectpicker');
    var selectedValues = [];

    $(window).on('load', function () {
        selector.selectpicker('val', '');
        selector.selectpicker('refresh');
    });

    window.onload = function () {
        /*自定义错误提示信息的方法*/
        jQuery.validator.addMethod("usernameFuc", function (value, element) {//用户名验证

            var name = /^[0-9a-zA-Z]{5,20}$/;
            return this.optional(element) || (name.test(value));
        }, "请输入5-20位英文字母或数字组合");


        $("#form").validate({
            errorPlacement: function (error, element) {
                element.parent().append(error);
            },
            rules: {
                user_name: {
                    required: true,
                    usernameFuc: true,
                    //判断 用户名是否重复
                    remote: {
                        url: "${G.host}/sysUser/checkUser",     //后台处理程序
                        type: "post",               //数据发送方式
                        dataType: "json",           //接受数据格式
                        data: {                     //要传递的数据
                            username: function () {
                                return $("#user_name").val();
                            },
                            markname: function () {
                                return $("#user_id").val();
                            }
                        },
                        dataFilter: function (data, type) {//判断控制器返回的内容
                            //console.log(data);
                            if (data == "false") {
                                return true;
                            } else {
                                return false;
                            }
                        }
                    }
                }
            },
            messages: {
                user_name: {
                    remote: "该用户名称已存在"
                }
            }
        });


        /*加载数据*/
        var mode = $.request.queryString["mode"];
        var sysid = $.request.queryString["user_id"];
        var relid = $.request.queryString["rel_id"];
        if (sysid) {
            $('#pagename').html("修改用户信息");
            $("input,textarea").attr("placeholder", "");
            $(".hidefield").show();
            $.post(quick.serverUrl + '/getObj?user_id=' + sysid + "&i=" + Math.random(), function (data) {

                setForm(data);

                $('.selectpicker').selectpicker('val', data.role_ids.split(","));
 //               $('.selectpicker').selectpicker('val', data.dep_id);

                document.getElementsByName("user_state").checked = false;
                if (data.user_state == 1) {
                    $("#user_state1").attr("checked", "checked");
                } else {
                    $("#user_state0").attr("checked", "checked");
                }
                if (mode == "browse") {
                    viewRead();
                }
            });
        }

        // 保存
        $("#submit-form").click(function () {
            if (!($("#form").valid())) {
                return false;
            }
           if(!checkMail()) {
               alert("邮箱验证不通过,请输入正确的邮箱!");
               return false;
           }
            quick.submit(function(data) {
                if(data.code !== 1){
                    layer.msg('保存失败,'+ data.msg,{icon:1,time: 3000,skin: 'layer-ext-moon'});
                    isdone=true;
                    return;
                }
                layer.msg('保存成功',{icon:1,time: 1500,skin: 'layer-ext-moon'}, function(){
                    cancel();
                });
            });
        })
    };

    function selectJob() {
        $.ajax({
            type: "get",
            url: quick.baseUrl + "/userJob/getData",
            async: false,
            dataType: "json",
            success: function (data) {
                $("#job_id").append("<option selected hidden value=''>岗位</option><option value= ''>选择岗位</option>");
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    $("#job_id").append("<option  value=" + item.job_id + "> " + item.job_name + "</option>");
                }
            }
        });
    }

    selectJob();

    function selectDep() {
        $.ajax({
            type: "get",
            url: quick.baseUrl + "/userDepartment/getData?dep_state=1",
            async: false,
            dataType: "json",
            success: function (data) {
                $("#dep_id").append("<option selected hidden value=''>部门</option><option value= ''>选择部门</option>");
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    $("#dep_id").append("<option  value=" + item.dep_id + ">  " + item.dep_name + "</option>");
                }
            }
        });
    }

    selectDep();

    function selectRole() {
        $('.selectpicker').selectpicker({
            noneSelectedText: '请选择角色',
            size: 9
        });
        $.ajax({
            type: "get",
            url: quick.baseUrl + "/role/getData",
            async: false,
            dataType: "json",
            success: function (data) {
                var select = $("#role_id");
//            $("#role_id").append("<option selected hidden value=''>角色名称</option><option value= ''>选择用户角色</option>");
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    select.append("<option  value=" + item.role_id + " > " + item.role_name + "</option>");
                }
                $('.selectpicker').selectpicker('val', '');
                $('.selectpicker').selectpicker('refresh');
            }
        });
    }

    selectRole();

    function cancel() {
        window.location.href = quick.listUrl + urlDel(location.search, 'mode', 'user_id') + '&RFlag=1';
    }


    function checkMail(){
        var reg = new RegExp("^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$"); //正则表达式
        var mail = document.getElementById("user_email"); //要验证的对象
        if(mail.value === ""){ //输入不能为空
            return true;
        }else if(!reg.test(mail.value)){ //正则验证不通过，格式不对
            return false;
        }else{
            return true;
        }

    }
</script>
</html>